<?php

namespace gordian\reefknot\storage\session;

class SessionMock extends Session
{
	// Make the non-public storage property public so we can poke and prod it
	public $storage = NULL;
	
	protected function headersSent ()
	{
		return false;
	}
	
	protected function sessionId ()
	{
		return '';
	}
	
	protected function startSession ()
	{
		return true;
	}
	
	protected function setStorage ()
	{
		$this -> storage = array ();
	}
}

/**
 * Test class for Session.
 * Generated by PHPUnit on 2012-03-07 at 23:06:12.
 * 
 * @runTestsInSeparateProcess
 */
class SessionTest extends \PHPUnit_Framework_TestCase
{
	/**
	 * @var gordian\reefknot\storage\session\Session
	 */
	protected $object;

	/**
	 * Sets up the fixture, for example, opens a network connection.
	 * This method is called before a test is executed.
	 */
	protected function setUp ()
	{
		$this -> object = new SessionMock ('unittest');
	}

	/**
	 * Tears down the fixture, for example, closes a network connection.
	 * This method is called after a test is executed.
	 */
	protected function tearDown ()
	{
		
	}
	
	/**
	 * Test that attempting to start a session with an empty namespace throws an exception.  
	 */
	public function testConstructInvalidNamespaceThrowsException ()
	{
		$ex	= NULL;
		try
		{
			$test	= new Session ('');
		}
		catch (\Exception $e)
		{
			$ex	= $e;
		}
		$this -> assertInstanceOf ('\InvalidArgumentException', $ex);
	}
	
	/**
	 * Test that attempting to start the session with a non-scalar namespace throws an exception 
	 */
	public function testConstructInvalidNamespaceThrowsException2 ()
	{
		$ex	= NULL;
		try
		{
			$test	= new Session (array (1, 2, 3));
		}
		catch (\Exception $e)
		{
			$ex	= $e;
		}
		$this -> assertInstanceOf ('\InvalidArgumentException', $ex);
	}
	
	/**
	 * Test that we can add an item to the session 
	 */
	public function testCreateItem ()
	{
		$this -> assertEmpty ($this -> object -> storage);
		$this -> object ->  createItem ('This is a test', 'test');
		$this -> assertNotEmpty ($this -> object -> storage);
		$this -> assertEquals ('This is a test', $this -> object -> storage ['test']);
	}
	
	/**
	 * Test that trying to add an item with a non-scalar key throws an exception 
	 */
	public function testCreateItemInvalidKeyThrowsException ()
	{
		$ex	= NULL;
		try
		{
			$this -> object -> createItem ('asdfdsa', array (1, 2, 3));
		}
		catch (\Exception $e)
		{
			$ex	= $e;
		}
		$this -> assertInstanceOf ('\InvalidArgumentException', $ex);
	}
	
	/**
	 * Test that trying to add an item with no key throws an exception 
	 */
	public function testCreateItemInvalidKeyThrowsException2 ()
	{
		$ex	= NULL;
		try
		{
			$this -> object -> createItem ('asdfdsa', NULL);
		}
		catch (\Exception $e)
		{
			$ex	= $e;
		}
		$this -> assertInstanceOf ('\InvalidArgumentException', $ex);
	}
	
	/**
	 * Test that we can retrieve a stored item by key 
	 */
	public function testReadItem ()
	{
		$this -> assertNull ($this -> object ->  readItem ('test'));
		$this -> object ->  createItem ('This is a test', 'test');
		$this -> assertEquals ($this -> object ->  readItem ('test'), 'This is a test');
	}

	/**
	 * Test that we can remove a stored item by key 
	 */
	public function testDeleteItem ()
	{
		$this -> assertEmpty ($this -> object -> storage);
		$this -> object ->  createItem ('This is a test', 'test');
		$this -> assertNotEmpty ($this -> object -> storage);
		$this -> assertEquals ('This is a test', $this -> object -> storage ['test']);
		$this -> object ->  deleteItem ('test');
		$this -> assertEmpty ($this -> object -> storage);
	}

	/**
	 * Test that we can modify a stored item by key 
	 */
	public function testUpdateItem ()
	{
		$this -> assertEmpty ($this -> object -> storage);
		$this -> object ->  createItem ('This is a test', 'test');
		$this -> assertEquals ('This is a test', $this -> object -> storage ['test']);
		$this -> object ->  updateItem ('foofoofoo', 'test');
		$this -> assertEquals ('foofoofoo', $this -> object -> storage ['test']);
	}
	
	/**
	 * Test that trying to update an item with a non-scalar key throws an exception 
	 */
	public function testUpdateItemInvalidKeyThrowsException ()
	{
		$ex	= NULL;
		try
		{
			$this -> object -> updateItem ('asdfdsa', array (1, 2, 3));
		}
		catch (\Exception $e)
		{
			$ex	= $e;
		}
		$this -> assertInstanceOf ('\InvalidArgumentException', $ex);
	}
	
	/**
	 * Test that we can reset the session 
	 */
	public function testReset ()
	{
		$this -> assertEmpty ($this -> object -> storage);
		$this -> object ->  createItem ('This is a test', 'test')
						->  createItem ('This is another test', 'test2')
						->  createItem ('This is yet another test', 'test3');
		$this -> assertEquals (array (
			'test' => 'This is a test', 
			'test2' => 'This is another test', 
			'test3' => 'This is yet another test'), 
			$this -> object -> storage);
		$this -> object -> reset ();
		$this -> assertEmpty ($this -> object -> storage);
	}

	/**
	 * Test that we can determine if the session contains data 
	 */
	public function testHasData ()
	{
		$this -> assertEmpty ($this -> object -> storage);
		$this -> assertFalse ($this -> object -> hasData ());
		$this -> object ->  createItem ('This is a test', 'test');
		$this -> assertNotEmpty ($this -> object -> storage);
		$this -> assertTrue ($this -> object -> hasData ());
	}
	
	/**
	 * Test that we can get an accurate count of items stored in the session 
	 */
	public function testCount ()
	{
		$this -> assertEquals (count ($this -> object), 0);
		$this -> assertEquals ($this -> object -> count (), 0);
		$this -> object -> createItem (123, 1);
		$this -> object -> createItem ('abc', 2);
		$this -> object -> createItem (pi (), 3);
		$this -> object -> createItem (array (1, 2, 3), 4);
		$this -> object -> createItem (true, 5);
		$this -> assertEquals (count ($this -> object), 5);
		$this -> assertEquals ($this -> object -> count (), 5);
	}
	
	/**
	 * Test that we can iterate over the session through its Iterator interface 
	 */
	public function testIterate ()
	{
		$this -> object -> createItem (1, 1);
		$this -> object -> createItem (2, 2);
		$this -> object -> createItem (3, 3);
		$this -> object -> createItem (4, 4);
		$this -> object -> createItem (5, 5);
		
		$count = 1;
		foreach ($this -> object as $key => $val)
		{
			$this -> assertEquals ($key, $count);
			$this -> assertEquals ($val, $count);
			$count++;
		}
	}
}
